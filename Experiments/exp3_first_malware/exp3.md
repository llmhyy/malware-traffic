# Experiment 3

## Goals

The goal of this experiment is to make a first analysis of a malware. I want to see if the traffic is as clear as the one generated by our metasploit toy malware. Moreover, this is the first setup with a malicious malware inside our VM and I'm expecting me to make sure this is the best setup for this application.

## Procedure

First, I had to setup the VM. It's a standard Windows VM on virtualbox. I installed PIN on it for future works and other tools (Wireshark, ...). Having no previous experience with this kind of experiments, I cut the maximum of connections between the host and the VM (shared folders, clipboard, drag&drop between). On Internet, people suggest that intelligent malware can always exploit vulnerabilities to infect the host, but that it was unlikely.

Then, I have chosen this malware : https://www.malware-traffic-analysis.net/2019/09/25/index.html. It's a Trickbot malware. Trickbot was first a banking trojan and then evolved. It uses SSL to communicate with c&c servers, that's why we are interested.

Steps:

- Launch Wireshark to record network packets
- Launch `netstat.py` to map network activities with processes
- Launch the malware instrumented by pin and myPinTool

## Analysis

<img src="exp3.assets/Capture.PNG" alt="Capture" style="zoom: 50%;" />

The instrumentation generated a file with all function calls. After a quick analysis, it appears that a function (offset 0x13480) was looping. As I was more interested in the network captures and the logs were taking too much space on the guest hard-drive, I stopped pin and focused on Wireshark + netstat.

<img src="exp3.assets/Capture2.PNG" alt="Capture2" style="zoom:75%;" />

It appears that the malware performed a process injection and was trying to reach C2 servers. We see the process injection in the netstat log : svchost.exe performed the TCP connection. 

The malware tried to connect to multiple C2 servers without any success. It only received RST/ACK replies (port closed) or no reply at all.

## Conclusion

This experiment brings us the case of offline C2 servers. The next experiment will focus on a newer version of Trickbot. It also confirms us that the process injection need to be coped with during our future work.
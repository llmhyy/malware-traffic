import os
import gzip
from io import StringIO
import pandas as pd

def get_child_pids(current_pid, diff):
    """
    Get the child process pid of one process given its pid

    Args:
        current_pid (int): parent pid
        diff (pd dataframe): df recorded

    Returns:
        list: list of pids
    """

    childs = diff[diff["parent_pid"] == current_pid]
    if childs.shape[0] == 0:
        return [current_pid]
    return [current_pid] + [v for index, row in childs.iterrows() for v in get_child_pids(row["process_id"], diff)]


def get_malware_pids(malware_name="2020-09-30-Trickbot-EXE.exe"):
    """
    Get the pids of all the malware generated processes

    Args:
        malware_name (str, optional): name of the malware. Defaults to "2020-09-08-Trickbot-EXE-gtag-ono72.exe".

    Returns:
        list: list of pids
    """

    first = pd.read_csv("process_pre.csv")
    post = pd.read_csv("process_post.csv")

    first.drop(first.columns[0], axis=1, inplace=True)
    post.drop(post.columns[0], axis=1, inplace=True)

    diff = first.merge(post, indicator=True,
                       how='right').loc[lambda x: x['_merge'] != 'both']
    malware_pid = int(
        diff.loc[diff['process_name'] == malware_name]["process_id"])

    return get_child_pids(malware_pid, diff)


def gzip_to_string(file_path):
    """
    Open a gzip file and load the content in a string
    This function exists because the gzip may not be proprerly closed.
    In this case, the end is corrupted but the rest can be read.
    Args:
        file_path (string): path of the gzip file

    Returns:
        str: content of the gzip file
    """

    gzip_file = gzip.open(file_path, "rt")
    string = ""
    while True:
        try:
            line = gzip_file.readline()
            string += line
        except EOFError:
            break
    return string


def get_malware_traces():
    """
    Get a list of dataframe representing the frida trace
    Its current format is [time, api_name, category]

    Returns:
        list: list of dataframe
    """

    pids = list(set(get_malware_pids()))
    traces = []
    for pid in pids:
        if not os.path.isfile(f"frida_{pid}.txt.gz"):
            print("Trace for {pid} does not exist")
        header = ["time", "api", "category"]
        frida_str = StringIO(gzip_to_string(f"frida_{pid}.txt.gz"))
        dataframe = pd.read_csv(frida_str, names=header, compression='gzip')
        dataframe.drop(dataframe.loc[dataframe['api'] == 'error'].index, inplace=True)
        dataframe.drop_duplicates(subset=['time', 'api'], keep='first', inplace=True)
        dataframe.reset_index(drop=True, inplace=True)
        traces.append(dataframe)
        dataframe["time_int"] = (dataframe["time"] * 1000000).astype(int)
    return traces


if __name__ == "__main__":
    print(get_malware_traces())

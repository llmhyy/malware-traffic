from segmentation import get_segmentation
import matplotlib.pyplot as plt
import numpy as np

color_dictionary = {
    'HANDSHAKE': 'xkcd:goldenrod',
    'TERM': 'xkcd:maroon',
    "IN":  'xkcd:green',
    'IN_TLS': 'xkcd:chartreuse',
    'OUT': 'xkcd:blue',
    'OUT_TLS': 'xkcd:sky blue',
    'TERM_RST': 'xkcd:red',
    "HANDSHAKE_FAILED": 'xkcd:red',
    'TLS_handshake': 'tab:brown',
    'Failed_TLS_handshake': 'xkcd:crimson'
}

def visualise():
    # Get the segmentation in flows
    segmentations, time_offsets = get_segmentation()

    # Initialize plot
    fig, ax = plt.subplots(figsize=(20, 10))
    # Help to construct the sequential plot
    last_indexes = [0]

    for j in range(len(segmentations)):
        segmentation = segmentations[j]
        # For each group of packet, draw in the plot with the corresponding colors
        time_offset = time_offsets[j]
        # list of [type, nb of packet interval, time interval, (size)]
        print(segmentation)

        # For each identified type, draw it with correct color
        for i in range(len(segmentation)):

            COLOR = color_dictionary.get(segmentation[i][0], 'tab:blue')
            ax.broken_barh([(time_offset + int(segmentation[i][1][0]), 1+int(segmentation[i][1][1]) -
                            int(segmentation[i][1][0]))], (0, 2), facecolors=COLOR, label=segmentation[i][0])
            # ax.broken_barh([(segmentation[i][2][0], segmentation[i][2][1]-segmentation[i][2][0])], (10*j, 9), facecolors=color, label=segmentation[i][0])

            ax.grid(True)

        handles, labels = plt.gca().get_legend_handles_labels()
        by_label = dict(zip(labels, handles))
        plt.legend(by_label.values(), by_label.keys(), loc=4)

    plt.xlabel('Time (arbitrary)')
    plt.ylabel('TCP Socket')
    plt.title("TCP Segmentation visualization")
    plt.show()


if __name__ == '__main__':
    visualise()
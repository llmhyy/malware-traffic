from segmentation import get_segmentation
from api_extraction import get_malware_traces, get_segmented_flow_syscalls
from clustering import cluster_segmented_flow, segmented_to_char
import matplotlib.pyplot as plt
import numpy as np

# TODO: properly handle this
MALWARE_NAME = "2020-09-30-Trickbot-EXE.exe"
PATH = "./trickbot_1/"
TIME_DELAY_ALLOWED = 0


def correlate():
    # Get the segmentation in flows
    segmentations, _ = get_segmentation(path=PATH)
    nb_class = 3
    cluster_indexes = cluster_segmented_flow(segmentations, nb_class=nb_class)
    call_dict = {k: np.empty((0, 4)) for k in range(nb_class)}
    for i in range(len(segmentations)):
        segmentation = segmentations[i]
        cluster = cluster_indexes[i]
        syscalls = get_segmented_flow_syscalls(segmentation, path=PATH)
        if syscalls.shape[0]:
            call_dict[cluster] = np.vstack((call_dict[cluster], syscalls))
    print(call_dict[2])

if __name__ == "__main__":
    correlate()

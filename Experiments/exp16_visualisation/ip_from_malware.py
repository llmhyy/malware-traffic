import pandas as pd
import numpy as np


def get_child_pids(current_pid, diff):
	"""
	Get the child process pid of one process given its pid

	Args:
		current_pid (int): parent pid
		diff (pd dataframe): df recorded

	Returns:
		list: list of pids
	"""
	
	childs = diff[diff["parent_pid"] == current_pid]
	if childs.shape[0] == 0:
		return [current_pid]
	return [current_pid] + [v for index, row in childs.iterrows() for v in get_child_pids(row["process_id"], diff)]


def ip_from_process_name(malware_name="malware.exe", path="./"):
	"""
	Get the IPs used in TCP packets by a malware and its child, given the parent malware process name

	Args:
		malware_name (str, optional): name of the malware. Defaults to "2020-09-08-Trickbot-EXE-gtag-ono72.exe".

	Returns:
		list: corresponding ips. If empty, the segmentation will take all the IP addresses
	"""
	
	first = pd.read_csv(path + "process_pre.csv")
	post = pd.read_csv(path + "process_post.csv")
	
	first.drop(first.columns[0], axis=1, inplace=True)
	post.drop(post.columns[0], axis=1, inplace=True)
	
	diff = first.merge(post, indicator=True, how='right').loc[lambda x: x['_merge'] != 'both']
	try:
		malware_pid = int(diff.loc[diff['process_name'] == malware_name]["process_id"].astype(float))
	except TypeError:
		raise RuntimeError('Malware PID not found, check malware name')
	netstat = pd.read_csv(path + "netstat.csv")
	netstat.drop(netstat.columns[0], axis=1, inplace=True)
	
	def fun(arg):
		return arg.split(":")[0]
	
	ips_filtered = list(map(fun, np.unique(
		netstat[netstat["Process ID"].isin(list(set(get_child_pids(malware_pid, diff))))]["Destination"].dropna(
			inplace=False).to_numpy())))
	return ips_filtered


def ip_from_pid(pid=5444):
	"""
	Get the IPs used in TCP packets by a malware and its child, given the parent malware PID

	Args:
		pid (int, optional): pid of the malware. Defaults to 5444.

	Returns:
		list: corresponding ips. If empty, the segmentation will take all the IP addresses
	"""
	
	first = pd.read_csv(path + "process_pre.csv")
	post = pd.read_csv(path + "process_post.csv")
	
	first.drop(first.columns[0], axis=1, inplace=True)
	post.drop(post.columns[0], axis=1, inplace=True)
	
	diff = first.merge(post, indicator=True,
	                   how='right').loc[lambda x: x['_merge'] != 'both']
	
	netstat = pd.read_csv(path + "netstat.csv")
	netstat.drop(netstat.columns[0], axis=1, inplace=True)
	
	def fun(arg):
		return arg.split(":")[0]
	
	ips_filtered = list(map(fun, np.unique(netstat[netstat["Process ID"].isin(
		list(set(get_child_pids(pid, diff))))]["Destination"].to_numpy())))
	return ips_filtered


if __name__ == "__main__":
	ip_from_process_name()
